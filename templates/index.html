<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Table with Filtering</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        .filter-row {
            margin-bottom: 1rem;
        }
        .filter-input {
            box-sizing: border-box; /* Ensure padding doesn't affect width */
            width: 100%; /* Initial width, will be overridden by JS */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Data Table</h2>
        <!-- Filter Inputs -->
        <div class="row filter-row" id="filter-row"></div>
        <!-- Table -->
        <table id="dataTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr id="table-headers"></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- Custom JavaScript -->
    <script>
        $(document).ready(function() {
            // Fetch schema to build table headers and filters
            $.getJSON('/schema', function(schema) {
                // Map schema array to columns array, preserving order
                const columns = schema.map(item => ({
                    title: item.name.charAt(0).toUpperCase() + item.name.slice(1),
                    data: item.name
                }));

                // Set table headers
                const headerRow = $('#table-headers');
                columns.forEach(col => {
                    headerRow.append(`<th>${col.title}</th>`);
                });

                // Create filter inputs
                const filterRow = $('#filter-row');
                columns.forEach(col => {
                    filterRow.append(`
                        <div class="col">
                            <input type="text" class="form-control filter-input" id="filter-${col.data}" data-column="${col.data}" placeholder="Filter ${col.title}">
                        </div>
                    `);
                });

                // Initialize DataTable
                const table = $('#dataTable').DataTable({
                    ajax: {
                        url: '/data',
                        dataSrc: ''
                    },
                    columns: columns,
                    dom: 't', // Show only the table (no default search or pagination)
                    pageLength: 10,
                    initComplete: function() {
                        // After DataTable initialization, align filter widths with headers
                        this.api().columns().every(function() {
                            const column = this;
                            const header = $(column.header());
                            const filterInput = $(`#filter-${column.data()}`);
                            if (filterInput.length) {
                                filterInput.css('width', header.outerWidth() + 'px');
                            }
                        });
                    }
                });

                // Apply column filters
                $('.filter-input').on('keyup change', function() {
                    const column = $(this).data('column');
                    const value = $(this).val();
                    table.column(columns.findIndex(col => col.data === column)).search(value).draw();
                });
            });
        });
    </script>
</body>
</html>
